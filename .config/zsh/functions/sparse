#autoload
#!/usr/bin/env zsh
# zsh required for nested parameter expansion
# Adding fzf features to my old ~/bin/repairTM.sh script

SPARSEBUNDLE="$(mdfind "kMDItemContentType = com.apple.disk-image-sparse-bundle" | fzf)"

repair_sparsebundle() {
  echo "ğŸ§²ğŸ”¼Attaching sparse bundle: $SPARSEBUNDLE"
  local DISK=`hdiutil attach -nomount -readwrite -noverify -noautofsck "${SPARSEBUNDLE}" | grep Apple_HFS | cut -f 1`

  echo "ğŸ› ï¸Repairing volume: $DISK"
  # The letters â€œdrfyâ€ tell the filecheck utility different things.
  # - d for â€˜Show Debugâ€™ 
  # â€“ r for â€˜Rebuild Catalog Treeâ€™ 
  # â€“ f for â€˜Forceâ€™ 
  # and y for assume â€˜yesâ€™ to any prompts.
  /sbin/fsck_hfs -drfy "${DISK}"

  # Check to make sure it was repaired sucessfully
  echo "ğŸ”Checking logs for errors"
  tail -7 /var/log/fsck_hfs.log
  # result=â€˜The Volume was repaired successfullyâ€™

  echo "âï¸Detaching ${DISK}"
  hdiutil detach "${DISK}"
}

imageinfo() {
  hdiutil imageinfo "${SPARSEBUNDLE}"
}

resize() {
  SIZE=$1
  hdiutil resize -size ${SiZE} "${SPARSEBUNDLE}"
}

"${@:-imageinfo}"

